pipeline {
    agent { label 'Slave1'}

    tools {
        // Install the Maven version configured as "M3" and add it to the path.
        maven "MAVEN"
    }

    stages {
        stage('SCM Checkout') {
            steps {
                // Get some code from a GitHub repository
                git 'https://github.com/MaithiliPatel/HelloWorldMaven.git'
		  }
		}
	stage('Maven Build') {
                steps{
		// Run Maven on a Unix agent.
                sh "mvn -Dmaven.test.failure.ignore=true clean package"

                }
            }
	stage('Copy JAR to Docker VM') {
            steps {
                sshPublisher(
                    publishers: [
                        sshPublisherDesc(
                            configName: 'docker',
                            transfers: [
                                sshTransfer(
                                    sourceFiles: 'target/HelloWorldMaven-1.1.1-RELEASE.jar',
                                    remoteDirectory: '/home/docker1',
                                    removePrefix: 'target',
                                    flatten: true
                                )
                            ],
                            verbose: true
                        )
                    ]
                )
            }
        }
		
	stage('Build Docker Image') {
            steps {
                sshPublisher(publishers: [
                    sshPublisherDesc(
                        configName: 'docker',
                        transfers: [],
                        execCommand: 'docker build -t maithili28/hello-world:v1 .',
                        verbose: true
                    )
                ])
            }
        }

    stage('Push Docker Image to Docker Hub') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-cred', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    sshPublisher(publishers: [
                        sshPublisherDesc(
                            configName: 'docker',
                            transfers: [],
                            execCommand: '''
                                docker login -u $USER -p $PASS
                                docker push maithili28/hello-world:v1
                            ''',
                            verbose: true
                        )
                    ])
                }
            }
        }
	}	
}








