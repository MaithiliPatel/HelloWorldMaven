pipeline {
    agent { label 'Slave1' }

    tools {
        maven "MAVEN"
    }

    stages {

        stage('SCM Checkout') {
            steps {
                git 'https://github.com/MaithiliPatel/HelloWorldMaven.git'
            }
        }

        stage('Maven Build') {
            steps {
                sh "mvn -Dmaven.test.failure.ignore=true clean package"
            }
        }

        stage('Copy JAR to Docker VM') {
            steps {
                sshPublisher(publishers: [
                    sshPublisherDesc(
                        configName: 'docker-ssh',
                        transfers: [
                            sshTransfer(
                                sourceFiles: 'target/HelloWorldMaven-1.1.1-RELEASE.jar',
                                removePrefix: 'target',
                                remoteDirectory: '.'
                            )
                        ],
                        verbose: true
                    )
                ])
            }
        }

        stage('Build Docker Image on Docker VM') {
            steps {
                sshCommand(
                    remote: [
                        name: 'docker-ssh',
                        host: '172.31.34.221',
                        user: 'docker1',
                        credentialsId: 'docker-ssh',
                        port: 22,
                        allowAnyHosts: true
                    ],
                    command: '''
                        cd /home/docker1
                        docker build -t maithili28/hello-world:v1 .
                    '''
                )
            }
        }

        stage('Push Docker Image to Docker Hub') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-cred', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    sshCommand(
                        remote: [
                            name: 'docker-ssh',
                            host: '172.31.34.221',
                            user: 'docker1',
                            credentialsId: 'docker-ssh',
                            port: 22,
                            allowAnyHosts: true
                        ],
                        command: '''
                            echo "$PASS" | docker login -u "$USER" --password-stdin
                            docker push maithili28/hello-world:v1
                        '''
                    )
                }
            }
        }
    }
}
