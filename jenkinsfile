pipeline {
    agent { label 'Slave1' }

    tools {
        maven "MAVEN"
    }

    stages {

        stage('SCM Checkout') {
            steps {
                git 'https://github.com/MaithiliPatel/HelloWorldMaven.git'
            }
        }

        stage('Maven Build') {
            steps {
                sh "mvn -Dmaven.test.failure.ignore=true clean package"
            }
        }

        stage('Copy JAR & Dockerfile to Docker VM') {
            steps {

                // Create folder on Docker VM
                sshCommand remote: [
                    name: 'docker',
                    host: '172.31.34.221',
                    user: 'docker1',
                    credentialsId: 'docker-ssh',   // GLOBAL CREDENTIAL
                    port: 22,
                    allowAnyHosts: true
                ], command: 'mkdir -p /home/docker1/app'

                // Copy JAR
                sshPut remote: [
                    name: 'docker',
                    host: '172.31.34.221',
                    user: 'docker1',
                    credentialsId: 'docker-ssh',
                    port: 22,
                    allowAnyHosts: true
                ], from: 'target/HelloWorldMaven-1.1.1-RELEASE.jar', into: '/home/docker1/app/'

                // Copy Dockerfile
                sshPut remote: [
                    name: 'docker',
                    host: '172.31.34.221',
                    user: 'docker1',
                    credentialsId: 'docker-ssh',
                    port: 22,
                    allowAnyHosts: true
                ], from: 'Dockerfile', into: '/home/docker1/app/'
            }
        }

        stage('Build Docker Image on Docker VM') {
            steps {
                sshCommand remote: [
                    name: 'docker',
                    host: '172.31.34.221',
                    user: 'docker1',
                    credentialsId: 'docker-ssh',
                    port: 22,
                    allowAnyHosts: true
                ], command: '''
                    cd /home/docker1/app
                    docker build -t maithili28/hello-world:v1 .
                '''
            }
        }

        stage('Push Docker Image to Docker Hub') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-cred',
                    usernameVariable: 'USER',
                    passwordVariable: 'PASS'
                )]) {

                    sshCommand remote: [
                        name: 'docker',
                        host: '172.31.34.221',
                        user: 'docker1',
                        credentialsId: 'docker-ssh',
                        port: 22,
                        allowAnyHosts: true
                    ], command: '''
                        echo "$PASS" | docker login -u "$USER" --password-stdin
                        docker push maithili28/hello-world:v1
                    '''
                }
            }
        }
    }
}
